<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Admin - User Information</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #121212;
            color: #f0f0f0;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            overflow-x: auto;
        }

        th,
        td {
            padding: 10px;
            border: 1px solid #333;
            text-align: center;
        }

        th {
            background-color: #1e1e1e;
        }

        input[type="search"] {
            margin: 10px 0;
            padding: 8px;
            width: 100%;
            max-width: 300px;
            border: none;
            border-radius: 4px;
        }

        h2 {
            margin-top: 40px;
            color: #ffffff;
        }

        button.logout-btn {
            padding: 8px 16px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button.logout-btn:hover {
            background-color: #d32f2f;
        }

        button.action-btn {
            padding: 8px 16px;
            background-color: #f44336;
            /* red (for delete) */
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button.action-btn:hover {
            background-color: #d32f2f;
        }

        button.reset-btn {
            padding: 8px 16px;
            background-color: #2196f3;
            /* blue */
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button.reset-btn:hover {
            background-color: #1976d2;
        }

        @media (max-width: 600px) {

            th,
            td {
                font-size: 12px;
                padding: 6px;
            }

            h1,
            h2 {
                font-size: 18px;
            }
        }
    </style>
</head>

<body>

    <div class="header">
        <h1>ADMIN</h1>
        <button class="logout-btn" onclick="logout()">Log Out</button>
    </div>
    <input type="search" id="searchUser" placeholder="Find user...">

    <h2>Google Sign-In Users</h2>
    <div style="overflow-x: auto;">
        <table id="googleUserTable">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Username</th>
                    <th>Password</th>
                    <th>Created At</th>
                    <th>Email</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <h2>Username Sign-In Users</h2>
    <div style="overflow-x: auto;">
        <table id="usernameUserTable">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Username</th>
                    <th>Password</th>
                    <th>Created At</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        async function fetchUsers() {
            try {
                const response = await fetch('/admin/users');
                if (!response.ok) throw new Error('Network error');

                const users = await response.json();
                const googleTbody = document.querySelector('#googleUserTable tbody');
                const usernameTbody = document.querySelector('#usernameUserTable tbody');

                googleTbody.innerHTML = '';
                usernameTbody.innerHTML = '';

                let googleCount = 0;
                let usernameCount = 0;

                users.forEach((user) => {
                    const createdAt = user.created_at ? new Date(user.created_at).toLocaleString() : '(no date)';

                    const actions = `
                        <button class="reset-btn" onclick="resetPassword('${user.id}')">Reset</button>
                        <button class="action-btn" onclick="deleteUser('${user.id}')">Delete</button>
                    `;

                    if (user.google_id) {
                        googleCount++;
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${googleCount}</td>
                            <td>${user.username}</td>
                            <td>********</td>
                            <td>${createdAt}</td>
                            <td>${user.email}</td>
                            <td>${actions}</td>
                        `;
                        googleTbody.appendChild(tr);
                    } else {
                        usernameCount++;
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${usernameCount}</td>
                            <td>${user.username}</td>
                            <td>********</td>
                            <td>${createdAt}</td>
                            <td>${actions}</td>
                        `;
                        usernameTbody.appendChild(tr);
                    }
                });
            } catch (err) {
                console.error('Error:', err);
                document.querySelector('#googleUserTable tbody').innerHTML = '<tr><td colspan="6">Error loading users.</td></tr>';
                document.querySelector('#usernameUserTable tbody').innerHTML = '<tr><td colspan="5">Error loading users.</td></tr>';
            }
        }

        function resetPassword(userId) {
            Swal.fire({
                title: 'ðŸ”’ Reset User Password',
                html: `
            <input type="password" id="newPassword" class="swal2-input" placeholder="New password (any format)">
        `,
                showCancelButton: true,
                confirmButtonText: 'Save',
                cancelButtonText: 'Cancel',
                focusConfirm: false,
                preConfirm: () => {
                    const newPassword = Swal.getPopup().querySelector('#newPassword').value;
                    if (!newPassword) {
                        Swal.showValidationMessage('Password cannot be empty!');
                        return false;
                    }
                    return fetch(`/admin/reset-password/${userId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ newPassword: newPassword })
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (!data.success) {
                                throw new Error(data.message || 'Failed to reset password.');
                            }
                            return data;
                        })
                        .catch(err => {
                            Swal.showValidationMessage(`Request failed: ${err}`);
                        });
                },
                allowOutsideClick: () => !Swal.isLoading()
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        icon: 'success',
                        title: 'âœ… Password Updated',
                        text: result.value.message,
                        timer: 1500,
                        showConfirmButton: false,
                        position: 'top-end',
                        toast: true
                    });
                }
            });
        }



        function deleteUser(userId) {
            Swal.fire({
                title: 'âš ï¸ Are you sure?',
                text: 'This action cannot be undone. Do you really want to delete this user?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/admin/delete-user/${userId}`, { method: 'DELETE' })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Deleted!',
                                    text: 'User successfully deleted from MySQL.',
                                    timer: 1500,
                                    showConfirmButton: false,
                                    position: 'top-end',
                                    toast: true
                                });
                                fetchUsers();
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Failed',
                                    text: 'Failed to delete user: ' + data.message
                                });
                            }
                        })
                        .catch(err => {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'Error deleting user.'
                            });
                        });
                }
            });
        }


        function logout() {
            window.location.href = 'index.html';
        }

        document.getElementById('searchUser').addEventListener('input', function () {
            const searchValue = this.value.toLowerCase();
            const allRows = document.querySelectorAll('tbody tr');

            allRows.forEach(row => {
                const username = row.children[1].textContent.toLowerCase();
                row.style.display = username.includes(searchValue) ? '' : 'none';
            });
        });

        window.onload = fetchUsers;
    </script>
</body>

</html>